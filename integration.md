# PayRam Merchant Integration Document

Merchant has to do the following integration steps to enable support for their self-hosted PayRam Payments.

## API Integration
To enable payments get confirmation of the payment, two APIs have to be added to Merchant's backend.

* Payment Session Creation
* Webhook to receive Payment Confirmation

### Base URLs
There are three servers involved in the payment cycle:

#### Merchant Server:
https://yourdomain.com - Merchant's server where user has the option to pay with `Payram`.

#### Payram API Backend & payment processor:
https://payram-api.yourdomain.com - Merchant's Payram backend server, that creates, processes and accepts payments and sends webhooks back to the merchants for confirmation of payment.

#### Payram Payment Server:
https://payram.yourdomain.com - The Payment server which serves the payment page with the `amount`, `currency`, `QR Code` etc. Merchant will receive a payment link, which when the merchant redirects the user, the user comes to this page.

### Payment Session Creation:
#### Form
Check this repo for an example merchat site:
https://github.com/PayRam/merchant-mock

On the merchant's client side(`webpage`) add a `form` to send the order details as in the following example, with your own `Pay with Payram` button:

```HTML
<form action="/pay-with-payram" method="post">
  <input name="amount" value="0.1">
  <input name="currency" value="USDC">
  <input name="invoice_id" value="INV003">
  <input name="customer_id" value="user_001">
  <input name="customer_email" value="a@b.c">
  <input name="expire" value="2024-01-31">
  <button type="submit">Pay with Payram</button>
</form>
```

On the merchant's server side add the logic to process the form and send a `POST` request to your payram backend server to create the `payment session`. Process the `response` of the `POST` request, extracting the `referece_id` - to track payment details, `url` - to redirect the user to make payment. 

#### `request` and `response` objects for payment session creation"
The `POST` request should send the following the `request data` to the payram backend server:
```bash
base url: https://payram.yourdomain.com
endpoint: /api/v1/payram-payment-session
request body
{
     amount,         # (string) Amount of the payment (eg., 0.001 for ETH, 100 for USDC etc.,)
     currency,       # (string) Currency of the payment, (ETH, USDC, USDT etc.,)
     invoice_id,     # (string) [OPTIONAL] <INVOICE ID> Merchant's Invoice ID for the payment
     customer_id,    # (string) The <USER ID> of the paying user as identified on the merchant's side(unique for each user.)
     customer_email  # (string) [OPTIONAL] The <USER EMAIL> of the paying user.
     expire,         # (string) [OPTIONAL] <EXPIRY TIME> for the payment
}
```

The `response data` will contain a payment link which the Merchant needs to redirect the user to:
```bash
response body
{
     reference_id, # (string) Reference ID generated by the payram's backend server for this payment session creation request.
                   # The Merchant should store this to keep track of the payment, if they didn't send the Invoice ID.
     url,          # (string) The Payment link for this payment
}
```

When the response is received, extract the 
- `reference_id` *STORE THIS IN YOU DB. THIS IS USED TO TRACK PAYMENTS*
- `payment url` and redirect the user to that payment link.

#### Example for payment session:
Here's an example in `NodeJS` backend that processes the form data, send the `POST` request, parse the `response` and redirect the user to the `payment url`.

```javascript
// Handle the form submission by sending a POST request to the Payram server, parse the resppnse and redirect the user
app.post('/pay-with-payram', async (req, res) => {
  try {
    const { amount, currency, invoice_id, customer_id, customer_email, expire } = req.body
    const payramResponse = await axios.post(
      'https://payram-api.yourdomain.com/api/v1/payram-payment-session',
      {
        amount,
        currency,
        invoice_id,
        customer_id,
        customer_email,
        expire,
      }
    )
    console.log('Payram response:', payramResponse.data)
    // Redirect the user to the Payram payment page
    res.redirect(303, payramResponse.data.url)
  } catch (error) {
    console.error('Error submitting invoice to Payram:', error)
    res.status(500).send('Error processing payment.')
  }
})
```

### Webhook
Once, any `transaction` has been processed against the `payment`, the merchant will receive a `webhook`. The `webhook` is a `GET` request to the Merchant's server.
Merchant has to accept the `webhook` request, parse the `data` and send back confirmation of the receipt.

#### `request` and `response` objects for payment session creation"

The PayRam backend's `GET` request sends the following the `request data` to the Merchant's server:
On Merchant server, create an endpoint with the following details:
```bash
endpoint: /payram-webhook
request body
{
     customer_id,      # (string) The <USER ID> of the paying user as identified on the merchant's side(unique for each user.)
     reference_id,     # (string) Reference ID of the payment when payment session was created.
     invoice_id,       # (string) [OPTIONAL] If the Merchant sent the Invoice ID, it is sent back here.
     status,           # (string) Payment status
                       # Following statuses are possible, {OPEN, VERIFYING, FILLED, OVER_FILLED, PARTIALLY_FILLED}
                       # When receiving FILLED/OVER_FILLED, merchant should mark the payment as complete.
     amount,           # (string) Amount filled for this payment until now.
     currency,         # (string) The currency symbol (ETH, USDC, USDT)
     filled_amount     # (string) Total Filled amount till now.
     filled_amount_usd # (string) Total Filled amount till now in USD value.
     timestamp         # (string) UNIX Timestamp of the last tranaction received (in seconds)
     payment_info,     # (object) Work In Progress. Don't process this.
}
```

After processing the above data, send out the confirmation of receipt of the above webhook data, by sending the following response:
```bash
response body
{
     received, # (bool) True if processed, False on failure to process the webhook data.
}
```

#### Example for webhook:
Here's an example in `NodeJS` backend that processes the webhook `request`, and sends a `OK` response back to `payram` api backend.

```javascript
// Webhook endpoint to receive notifications from Payram
app.post('/payram-webhook', async (req, res) => {
  const { customer_id, invoice_id, reference_id, status, amount, currency, filled_amount, filled_amount_usd, timestamp, payment_info } = req.body

  console.log(
    'Received webhook for transaction:',
    'with reference:',
    reference_id,
    'for user:',
    customer_id,
    'with status:',
    status,
    'and amount:',
    amount,
    'and filled amount:',
    filled_amount,
    'and filled amount in USD:',
    filled_amount_usd,
    'and timestamp:',
    timestamp,
  )
  // Here you would update your merchant's database and trigger any business logic
  // For example, confirming an order or updating an account balance

  // Respond to the Payram server to acknowledge receipt of the webhook
  res.status(200).send({ received: true })
})

app.listen(PORT, () => {
  console.log(`Merchant mock server running at http://localhost:${PORT}`)
})
```